@{
	ViewData["Title"] = "Session Manager";
	Layout = "~/Views/Shared/_LayoutNew.cshtml";
}

<!Doctype html>
<html>
<head>
	<title></title>
	<style>
		.nav-item.me-2.me-xl-50 {
			margin-right: 33rem !important;
		}

		.error_show {
			color: red;
			margin-left: 10px;
		}

		.k-grid-header th.k-header > .k-link {
			width: 100px;
		}

		.k-grid-header {
			font-weight: bold;
		}

		.k-grid-filter.k-state-active {
			color: #ffffff;
			background-color: #1274AC;
		}

		table {
			border: 1px solid #C5C5C5 !important;
		}

		.k-grid-content {
			overflow-x: hidden;
			height: 227px;
		}

		.k-content {
			font-weight: normal;
			font-size: 13px;
		}

		.k-widget.k-window {
			padding-top: 35px;
			min-width: 90px;
			min-height: 50px;
			width: 700px !important;
			height: 300px !important;
			top: 180.766px !important;
			/*left: 120px !important;*/
			z-index: 10003;
			left: 300px !important;
		}
	</style>
</head>
<body class="hold-transition skin-blue sidebar-mini fixed">
	<div class="content-wrapper">
		<div class="container-xxl flex-grow-1 container-p-y">
			<div class="card-body" style="margin-top: -1%; min-height: 82%;">
				<div id="gd_killjob">
					<div id="grid_killjob"> </div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>

<script type="text/javascript">
	$(document).ready(function () {
		 $("#navhead").text("Session Manager");
		getKilljob();
	});

	function getKilljob() {
		var actionBy = sessionStorage.getItem("usrname");
		$.ajax({
			type: "POST",
			url: '@Url.Action("getKilljob", "Killjob")',
			dataType: 'json',
			data: JSON.stringify({ processId: 0, action: "get", userCode: actionBy }),
			contentType: 'application/json; charset=utf-8',
			success: function (response) {
				if (response != null) {
					$("#grid_killjob").empty();
					$("#grid_killjob").append("<div id='grid_killjob'></div>");
					fetchGrid(JSON.parse(response));
				}
				else {
					fetchGrid();
				}
			},
			error: function (er) {
				alert(er)
				console.log(er)
			}
		});
	}

	function fetchGrid(data) {
		try {
			$("#grid_killjob").kendoGrid({
				dataSource: {
					data: data,
					pageSize: 15,
					schema: {
						model: {
							fields: {
								ID: { type: "number" },
								USER: { type: "string" },
								HOST: { type: "string" },
								DB: { type: "string" },
								COMMAND: { type: "string" },
								TIME: { type: "string" },
								STATE: { type: "string" },
								INFO: { type: "string" }
							}
						}
					}
				},
				height: 450,
				groupable: false,
				dataBound: function (e) {
					resultData = e.sender._data;
					var rows = $('#grid_killjob').data('kendoGrid').tbody.children();
					setColor(rows, resultData);
				},
				pageable: {
					refresh: false,
					pageSizes: [15, 20, 25, 50],
					buttonCount: 5
				},
				sortable: true,
				selectable: true,
				filterable: true,
				navigatable: true,
				resizable: true,
				columns: [
					{
						command: [
							{
								name: "Delete",
								id: "Delete",
								template: "<a href='' onclick='myDeleteJs(this)' class='k-grid-delete' data-bs-toggle='modal'><img src = '../Assets/images/del.png'></a>&nbsp;&nbsp;&nbsp;",
							},
						],
						title: "Action&nbsp;",
						width: "50px",
						attributes: { style: "text-align: center;" },
					},
					{
						field: "ID",
						title: "Job ID",
						width: 100,
						attributes: { style: "text-align: right;" },
						filterable: {
							ui: "numeric",
							extra: false,
						},
					},
					{
						field: "USER",
						title: "User",
						width: 100,
					},
					{
						field: "HOST",
						title: "Host",
						width: 100,
						hidden: true
					},
					{
						field: "DB",
						title: "Database",
						width: 100,
					},
					{
						field: "COMMAND",
						title: "Command",
						width: 100,
					},
					{
						field: "TIME",
						title: "Time",
						width: 120,
					},
					{
						field: "STATE",
						title: "State",
						width: 120,
					},
					{
						field: "INFO",
						title: "Info",
						width: 100,
					}
				],
				editable: false,
			});
		} catch (err) {
			console.log(err);
		}
	}

	function myDeleteJs(e) {
		$.confirm({
			icon: 'fa fa-warning',
			title: 'Recon',
			autoClose: 'cancel|10000',
			theme: 'dark',
			animationSpeed: 700,
			content: 'Are you sure you want to kill this job?',
			type: 'orange',
			buttons: {
				confirm: function () {
					var actionBy = sessionStorage.getItem("usrname");					
					var grid = $("#grid_killjob").data("kendoGrid");
					var model = grid.dataItem($(e).closest("tr"));
					var processid = model.ID;
					$.ajax({
						type: "POST",
						url: '@Url.Action("setKilljob", "Killjob")',
						dataType: 'json',
						data: JSON.stringify({ processId: processid, action: "kill", userCode: actionBy }),
						contentType: 'application/json; charset=utf-8',
						success: function (response) {
							if (response != null ) {
								if (JSON.parse(response)[0].out_result == 1)
								{
									$("#grid_killjob").empty();
									$("#grid_killjob").append("<div id='grid_killjob'></div>");
									$.alert({
										icon: 'fa fa-success',
										title: 'Recon',
										theme: 'dark',
										content: JSON.parse(response)[0].out_msg,
										type: 'green',
										animationSpeed: 700,
									});
									getKilljob();
								}
								else
								{
									$.alert({
										title: 'Recon',
										content: JSON.parse(response)[0].out_msg,
										type: 'red',
									});
								}
							}
						}
					});
				},
				cancel: function () {
					$.alert({
						icon: 'fa fa-success',
						title: 'Recon',
						theme: 'dark',
						content: 'Job kill action cancelled.!',
						type: 'blue',
						animationSpeed: 700,
					});
				},
			}
		});
	}
</script>